{% extends "layout.html" %}

{% block title %}Gestion des Factures - MKM Shop{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <!-- En-tête amélioré -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 mb-1 text-dark fw-bold">
                <i class="fas fa-file-invoice me-2 text-primary"></i>Gestion des Factures
            </h1>
            <p class="text-muted small mb-0">Consultation et gestion de l'historique des factures</p>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge bg-primary fs-6">
                <i class="fas fa-receipt me-1"></i>
                {{ factures|length }} facture(s)
            </span>
        </div>
    </div>

    <!-- Messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row mb-4">
                <div class="col-12">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show d-flex align-items-center" role="alert">
                            {% if category == 'success' %}
                                <i class="fas fa-check-circle me-2 fs-5"></i>
                            {% elif category == 'danger' %}
                                <i class="fas fa-exclamation-triangle me-2 fs-5"></i>
                            {% else %}
                                <i class="fas fa-info-circle me-2 fs-5"></i>
                            {% endif %}
                            <div class="flex-grow-1">{{ message }}</div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <!-- Formulaire de recherche et filtrage -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="fas fa-search me-2"></i> Rechercher et Filtrer
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('routes.factures') }}" id="filterForm">
                <div class="row g-3">
                    <!-- Recherche par nom client -->
                    <div class="col-md-4">
                        <label for="search" class="form-label fw-semibold">Nom du client</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-user text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_term }}" placeholder="Rechercher par nom client...">
                        </div>
                    </div>

                    <!-- Filtre par date de début -->
                    <div class="col-md-3">
                        <label for="start_date" class="form-label fw-semibold">Date de début</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-calendar-start text-muted"></i>
                            </span>
                            <input type="date" class="form-control" id="start_date" name="start_date">
                        </div>
                    </div>

                    <!-- Filtre par date de fin -->
                    <div class="col-md-3">
                        <label for="end_date" class="form-label fw-semibold">Date de fin</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-calendar-end text-muted"></i>
                            </span>
                            <input type="date" class="form-control" id="end_date" name="end_date">
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="d-grid gap-2 w-100">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i> Appliquer
                            </button>
                            <button type="button" id="resetFilters" class="btn btn-outline-secondary">
                                <i class="fas fa-sync-alt me-1"></i> Réinitialiser
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des factures -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-success text-white py-3">
            <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="fas fa-list me-2"></i> Liste des Factures
                <span class="badge bg-light text-success ms-2 fs-6">{{ factures|length }}</span>
            </h5>
        </div>
        <div class="card-body">
            {% if factures %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#ID</th>
                            <th>Client</th>
                            <th class="text-center">Mode Paiement</th>
                            <th class="text-end">Montant Total</th>
                            <th class="text-end">Cash</th>
                            <th class="text-end">Crédit</th>
                            <th class="text-center">Date</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for facture in factures %}
                        <tr class="facture-row" 
                            data-id="{{ facture.id }}" 
                            data-client="{{ facture.nom_client|lower }}" 
                            data-date="{{ facture.date_facture.strftime('%Y-%m-%d') }}"
                            data-montant="{{ facture.montant_total }}"
                            data-facture='{{ {
                                "id": facture.id,
                                "nom_client": facture.nom_client,
                                "montant_total": facture.montant_total,
                                "date_facture": facture.date_facture.strftime("%d/%m/%Y %H:%M"),
                                "paiement_credit": facture.paiement_credit,
                                "montant_cash": facture.montant_cash,
                                "montant_credit": facture.montant_credit
                            }|tojson }}'>
                            <td class="text-center fw-bold text-primary">{{ facture.id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle text-muted me-2"></i>
                                    <span class="fw-semibold">{{ facture.nom_client }}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                {% if facture.paiement_credit %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-credit-card me-1"></i>Crédit
                                </span>
                                {% else %}
                                <span class="badge bg-success">
                                    <i class="fas fa-money-bill-wave me-1"></i>Comptant
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold text-primary">{{ "%.2f"|format(facture.montant_total) }} $</td>
                            <td class="text-end text-success fw-semibold">{{ "%.2f"|format(facture.montant_cash) }} $</td>
                            <td class="text-end text-warning fw-semibold">{{ "%.2f"|format(facture.montant_credit) }} $</td>
                            <td class="text-center">
                                <div class="d-flex flex-column">
                                    <small class="text-muted">{{ facture.date_facture.strftime('%d/%m/%Y') }}</small>
                                    <small class="text-muted">{{ facture.date_facture.strftime('%H:%M') }}</small>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary view-details" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#detailsFactureModal"
                                            data-facture-id="{{ facture.id }}"
                                            title="Voir les détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning edit-facture-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editFactureModal"
                                            data-facture-id="{{ facture.id }}"
                                            title="Modifier la facture">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary imprimer-facture-btn"
                                            data-facture-id="{{ facture.id }}"
                                            title="Imprimer la facture">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Résumé statistique -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center py-3">
                            <h6 class="card-title mb-1">Total Factures</h6>
                            <h4 class="mb-0">{{ factures|length }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center py-3">
                            <h6 class="card-title mb-1">Total Ventes</h6>
                            <h4 class="mb-0">{{ "%.2f"|format(factures|sum(attribute='montant_total')) }} $</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center py-3">
                            <h6 class="card-title mb-1">En Comptant</h6>
                            <h4 class="mb-0">{{ "%.2f"|format(factures|selectattr('paiement_credit', 'equalto', false)|sum(attribute='montant_total')) }} $</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center py-3">
                            <h6 class="card-title mb-1">En Crédit</h6>
                            <h4 class="mb-0">{{ "%.2f"|format(factures|selectattr('paiement_credit')|sum(attribute='montant_credit')) }} $</h4>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- État vide -->
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-file-invoice fa-4x text-muted"></i>
                </div>
                <h4 class="text-muted mb-3">Aucune facture trouvée</h4>
                <p class="text-muted mb-4">
                    {% if search_term %}
                    Aucune facture ne correspond à votre recherche "{{ search_term }}"
                    {% else %}
                    Aucune facture n'a été enregistrée pour le moment.
                    {% endif %}
                </p>
                {% if not search_term %}
                <a href="{{ url_for('routes.ventes') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Créer une première vente
                </a>
                {% else %}
                <button onclick="resetSearch()" class="btn btn-outline-primary">
                    <i class="fas fa-sync-alt me-1"></i> Afficher toutes les factures
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modale pour les détails de la facture -->
<div class="modal fade" id="detailsFactureModal" tabindex="-1" aria-labelledby="detailsFactureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="detailsFactureModalLabel">
                    <i class="fas fa-file-invoice me-2"></i> Détails de la Facture
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="factureDetailsContent">
                    <!-- Le contenu sera chargé dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Fermer
                </button>
                <button type="button" class="btn btn-primary" onclick="imprimerFactureFromModal()">
                    <i class="fas fa-print me-1"></i> Imprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale pour l'édition de la facture -->
<div class="modal fade" id="editFactureModal" tabindex="-1" aria-labelledby="editFactureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editFactureModalLabel">
                    <i class="fas fa-edit me-2"></i> Modifier la Facture
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editFactureForm" method="POST" action="">
                <div class="modal-body">
                    <input type="hidden" id="edit_facture_id" name="facture_id">
                    
                    <!-- Informations générales -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Informations Générales</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="edit_nom_client" class="form-label fw-semibold">Nom du client *</label>
                                        <input type="text" class="form-control" id="edit_nom_client" name="nom_client" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="edit_montant_total" class="form-label fw-semibold">Montant total</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control fw-bold text-primary" id="edit_montant_total" readonly>
                                            <span class="input-group-text">$</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Mode de paiement</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="paiement_type" id="edit_paiement_comptant" value="comptant" checked>
                                            <label class="form-check-label" for="edit_paiement_comptant">
                                                <span class="badge bg-success">
                                                    <i class="fas fa-money-bill-wave me-1"></i> Comptant
                                                </span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="paiement_type" id="edit_paiement_credit" value="credit">
                                            <label class="form-check-label" for="edit_paiement_credit">
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-credit-card me-1"></i> Crédit
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Détails Paiement</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Section Cash (toujours visible) -->
                                    <div class="mb-3" id="edit_cash_section">
                                        <label for="edit_montant_cash" class="form-label fw-semibold">
                                            <i class="fas fa-money-bill-wave text-success me-1"></i>Montant payé en cash
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="edit_montant_cash" name="montant_cash" step="0.01" min="0" required>
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <small class="form-text text-muted">Montant déjà payé par le client</small>
                                    </div>
                                    
                                    <!-- Section Crédit (seulement pour paiement crédit) -->
                                    <div class="mb-3" id="edit_credit_section" style="display: none;">
                                        <label for="edit_montant_credit" class="form-label fw-semibold">
                                            <i class="fas fa-credit-card text-warning me-1"></i>Montant restant (crédit)
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="edit_montant_credit" name="montant_credit" step="0.01" min="0">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <small class="form-text text-muted">Montant restant à payer</small>
                                    </div>
                                    
                                    <!-- Affichage du solde -->
                                    <div class="alert alert-info mt-3" id="edit_balance_alert" style="display: none;">
                                        <div class="d-flex justify-content-between">
                                            <span>Total:</span>
                                            <strong id="edit_total_amount">0.00 $</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Cash:</span>
                                            <strong id="edit_cash_amount" class="text-success">0.00 $</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Crédit:</span>
                                            <strong id="edit_credit_amount" class="text-warning">0.00 $</strong>
                                        </div>
                                        <hr class="my-2">
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Solde:</span>
                                            <span id="edit_balance" class="text-primary">0.00 $</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Articles de la facture -->
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0"><i class="fas fa-boxes me-2"></i>Articles</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openEditArticlesModal()">
                                <i class="fas fa-edit me-1"></i> Modifier les articles
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Produit</th>
                                            <th class="text-center">Quantité</th>
                                            <th class="text-end">Prix unitaire</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="edit_articles_body">
                                        <!-- Les articles seront chargés dynamiquement -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light">
                                            <td colspan="3" class="text-end fw-bold">Total:</td>
                                            <td class="text-end fw-bold" id="edit_articles_total">0.00 $</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i> Enregistrer les modifications
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale pour modifier les articles (quantités et prix) -->
<div class="modal fade" id="editArticlesModal" tabindex="-1" aria-labelledby="editArticlesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="editArticlesModalLabel">
                    <i class="fas fa-edit me-2"></i> Modifier les Articles
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editArticlesContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEditedArticles()">
                    <i class="fas fa-save me-1"></i> Sauvegarder les modifications
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts pour la gestion de la page -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const factureRows = document.querySelectorAll('.facture-row');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        const viewDetailsButtons = document.querySelectorAll('.view-details');
        const imprimerFactureButtons = document.querySelectorAll('.imprimer-facture-btn');
        const editFactureButtons = document.querySelectorAll('.edit-facture-btn');

        // Fonction de filtrage côté client
        function filterFactures() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            let visibleCount = 0;

            factureRows.forEach(row => {
                const rowDate = row.getAttribute('data-date');
                let shouldShow = true;

                // Filtrage par date
                if (startDate && rowDate < startDate) {
                    shouldShow = false;
                }
                if (endDate && rowDate > endDate) {
                    shouldShow = false;
                }

                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Mettre à jour le compteur dans l'en-tête
            const countBadge = document.querySelector('.card-header .badge');
            if (countBadge) {
                countBadge.textContent = visibleCount;
            }
        }

        // Événements pour les filtres
        if (startDateInput) {
            startDateInput.addEventListener('change', filterFactures);
        }
        if (endDateInput) {
            endDateInput.addEventListener('change', filterFactures);
        }

        // Réinitialisation des filtres
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                startDateInput.value = '';
                endDateInput.value = '';
                filterFactures();
            });
        }

        // Gestion des détails de facture dans la modale
        viewDetailsButtons.forEach(button => {
            button.addEventListener('click', function() {
                const factureId = this.getAttribute('data-facture-id');
                chargerDetailsFacture(factureId);
            });
        });

        // Gestion du bouton d'impression direct
        imprimerFactureButtons.forEach(button => {
            button.addEventListener('click', function() {
                const factureId = this.getAttribute('data-facture-id');
                imprimerFacture(factureId);
            });
        });

        // Gestion du bouton d'édition
        editFactureButtons.forEach(button => {
            button.addEventListener('click', function() {
                const factureId = this.getAttribute('data-facture-id');
                chargerFacturePourEdition(factureId);
            });
        });

        // Gestion du changement de mode de paiement
        document.querySelectorAll('input[name="paiement_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updatePaiementFields();
                calculateBalance();
            });
        });

        // Gestion des changements de montants
        const editMontantCash = document.getElementById('edit_montant_cash');
        const editMontantCredit = document.getElementById('edit_montant_credit');
        if (editMontantCash) {
            editMontantCash.addEventListener('input', calculateBalance);
        }
        if (editMontantCredit) {
            editMontantCredit.addEventListener('input', calculateBalance);
        }

        // Soumission du formulaire d'édition
        const editFactureForm = document.getElementById('editFactureForm');
        if (editFactureForm) {
            editFactureForm.addEventListener('submit', function(e) {
                e.preventDefault();
                soumettreEditionFacture();
            });
        }

        // Initialiser le filtrage
        filterFactures();
    });

    // Fonction pour charger les détails d'une facture
    function chargerDetailsFacture(factureId) {
        fetch(`/factures/${factureId}/details.json`)
            .then(response => response.json())
            .then(data => {
                afficherDetailsFacture(data);
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('factureDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des détails de la facture.
                    </div>
                `;
            });
    }

    // Fonction pour afficher les détails dans la modale
    function afficherDetailsFacture(data) {
        const { facture, ventes } = data;
        
        let produitsHTML = '';
        ventes.forEach(vente => {
            produitsHTML += `
                <tr>
                    <td>${vente.produit_nom}</td>
                    <td class="text-center">${vente.quantite}</td>
                    <td class="text-end">${vente.prix_unitaire.toFixed(2)} $</td>
                    <td class="text-end fw-bold">${vente.montant_total.toFixed(2)} $</td>
                </tr>
            `;
        });

        const modalContent = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Informations Facture</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-semibold">N° Facture:</td>
                                    <td class="text-end fw-bold text-primary">${facture.id}</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Client:</td>
                                    <td class="text-end">${facture.nom_client}</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Date:</td>
                                    <td class="text-end">${facture.date_facture}</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Mode Paiement:</td>
                                    <td class="text-end">
                                        ${facture.paiement_credit ? 
                                            '<span class="badge bg-warning text-dark"><i class="fas fa-credit-card me-1"></i>Crédit</span>' : 
                                            '<span class="badge bg-success"><i class="fas fa-money-bill-wave me-1"></i>Comptant</span>'}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Détails Paiement</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-semibold">Total:</td>
                                    <td class="text-end fw-bold text-primary">${facture.montant_total.toFixed(2)} $</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Payé en cash:</td>
                                    <td class="text-end text-success">${facture.montant_cash.toFixed(2)} $</td>
                                </tr>
                                ${facture.paiement_credit ? `
                                <tr>
                                    <td class="fw-semibold">Reste crédit:</td>
                                    <td class="text-end text-warning">${facture.montant_credit.toFixed(2)} $</td>
                                </tr>
                                ` : ''}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0"><i class="fas fa-boxes me-2"></i>Produits Vendus</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Produit</th>
                                    <th class="text-center">Quantité</th>
                                    <th class="text-end">Prix Unitaire</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${produitsHTML}
                            </tbody>
                            <tfoot>
                                <tr class="table-success">
                                    <td colspan="3" class="text-end fw-bold">Total Général:</td>
                                    <td class="text-end fw-bold">${facture.montant_total.toFixed(2)} $</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('factureDetailsContent').innerHTML = modalContent;
        
        // Stocker l'ID de la facture pour l'impression
        document.getElementById('detailsFactureModal').setAttribute('data-current-facture-id', facture.id);
    }

    // Fonction pour imprimer depuis la modale
    function imprimerFactureFromModal() {
        const factureId = document.getElementById('detailsFactureModal').getAttribute('data-current-facture-id');
        if (factureId) {
            imprimerFacture(factureId);
        }
    }

    // Fonction pour charger les données d'une facture pour l'édition
    function chargerFacturePourEdition(factureId) {
        fetch(`/factures/${factureId}/edit`)
            .then(response => response.json())
            .then(data => {
                afficherFormulaireEdition(data);
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des données de la facture');
            });
    }

    // Fonction pour afficher le formulaire d'édition
    function afficherFormulaireEdition(data) {
        const { facture, ventes } = data;
        
        // Remplir les champs du formulaire
        document.getElementById('edit_facture_id').value = facture.id;
        document.getElementById('edit_nom_client').value = facture.nom_client;
        document.getElementById('edit_montant_total').value = facture.montant_total.toFixed(2);
        
        // Définir le mode de paiement
        if (facture.paiement_credit) {
            document.getElementById('edit_paiement_credit').checked = true;
            document.getElementById('edit_montant_credit').value = facture.montant_credit.toFixed(2);
            document.getElementById('edit_credit_section').style.display = 'block';
        } else {
            document.getElementById('edit_paiement_comptant').checked = true;
            document.getElementById('edit_montant_credit').value = '0.00';
            document.getElementById('edit_credit_section').style.display = 'none';
        }
        
        document.getElementById('edit_montant_cash').value = facture.montant_cash.toFixed(2);
        
        // Mettre à jour le formulaire d'action
        document.getElementById('editFactureForm').action = `/factures/${facture.id}/modifier`;
        
        // Afficher les articles
        afficherArticlesEdition(ventes);
        
        // Mettre à jour les champs de paiement et calculer le solde
        updatePaiementFields();
        calculateBalance();
    }

    // Fonction pour afficher les articles dans le formulaire d'édition
    function afficherArticlesEdition(ventes) {
        const tbody = document.getElementById('edit_articles_body');
        let html = '';
        let total = 0;
        
        ventes.forEach(vente => {
            total += vente.montant_total;
            html += `
                <tr>
                    <td>${vente.produit_nom}</td>
                    <td class="text-center">${vente.quantite}</td>
                    <td class="text-end">${vente.prix_unitaire.toFixed(2)} $</td>
                    <td class="text-end fw-bold">${vente.montant_total.toFixed(2)} $</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        document.getElementById('edit_articles_total').textContent = total.toFixed(2) + ' $';
    }

    // Fonction pour mettre à jour les champs de paiement
    function updatePaiementFields() {
        const paiementComptant = document.getElementById('edit_paiement_comptant').checked;
        const montantTotal = parseFloat(document.getElementById('edit_montant_total').value);
        
        if (paiementComptant) {
            // En comptant, tout est payé cash
            document.getElementById('edit_credit_section').style.display = 'none';
            document.getElementById('edit_montant_cash').value = montantTotal.toFixed(2);
            document.getElementById('edit_montant_cash').readOnly = true;
            document.getElementById('edit_montant_credit').value = '0.00';
        } else {
            // En crédit, on peut modifier les deux
            document.getElementById('edit_credit_section').style.display = 'block';
            document.getElementById('edit_montant_cash').readOnly = false;
            
            // Calculer automatiquement le crédit si le cash est inférieur au total
            const cash = parseFloat(document.getElementById('edit_montant_cash').value) || 0;
            if (cash < montantTotal) {
                document.getElementById('edit_montant_credit').value = (montantTotal - cash).toFixed(2);
            }
        }
    }

    // Fonction pour calculer et afficher le solde
    function calculateBalance() {
        const montantTotal = parseFloat(document.getElementById('edit_montant_total').value) || 0;
        const cash = parseFloat(document.getElementById('edit_montant_cash').value) || 0;
        const credit = parseFloat(document.getElementById('edit_montant_credit').value) || 0;
        const paiementComptant = document.getElementById('edit_paiement_comptant').checked;
        
        // Mettre à jour l'affichage des montants
        document.getElementById('edit_total_amount').textContent = montantTotal.toFixed(2) + ' $';
        document.getElementById('edit_cash_amount').textContent = cash.toFixed(2) + ' $';
        document.getElementById('edit_credit_amount').textContent = credit.toFixed(2) + ' $';
        
        // Calculer le solde
        const balance = montantTotal - (cash + credit);
        const balanceElement = document.getElementById('edit_balance');
        
        if (balance === 0) {
            balanceElement.textContent = '0.00 $';
            balanceElement.className = 'text-success';
        } else if (balance > 0) {
            balanceElement.textContent = '+' + balance.toFixed(2) + ' $';
            balanceElement.className = 'text-warning';
        } else {
            balanceElement.textContent = balance.toFixed(2) + ' $';
            balanceElement.className = 'text-danger';
        }
        
        // Afficher l'alerte de solde
        document.getElementById('edit_balance_alert').style.display = 'block';
        
        // Si en comptant, forcer le solde à 0
        if (paiementComptant) {
            document.getElementById('edit_balance').textContent = '0.00 $';
            document.getElementById('edit_balance').className = 'text-success';
        }
    }

    // Fonction pour soumettre le formulaire d'édition
    function soumettreEditionFacture() {
        const form = document.getElementById('editFactureForm');
        const formData = new FormData(form);
        
        // Validation supplémentaire
        const montantTotal = parseFloat(document.getElementById('edit_montant_total').value);
        const cash = parseFloat(document.getElementById('edit_montant_cash').value);
        const credit = parseFloat(document.getElementById('edit_montant_credit').value);
        
        if (document.getElementById('edit_paiement_credit').checked) {
            // Pour le crédit, vérifier que cash + credit = total
            if (Math.abs((cash + credit) - montantTotal) > 0.01) {
                alert('Pour un paiement en crédit, la somme du cash et du crédit doit être égale au montant total.');
                return false;
            }
        }
        
        // Soumettre le formulaire
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la modification de la facture');
        });
    }

    // Fonction pour ouvrir le modal de modification des articles
    function openEditArticlesModal() {
        const factureId = document.getElementById('edit_facture_id').value;
        
        fetch(`/factures/${factureId}/edit`)
            .then(response => response.json())
            .then(data => {
                afficherFormulaireArticles(data.ventes);
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des articles');
            });
    }

    // Fonction pour afficher le formulaire de modification des articles
    function afficherFormulaireArticles(ventes) {
        let html = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Produit</th>
                            <th class="text-center">Stock</th>
                            <th class="text-center">Quantité actuelle</th>
                            <th class="text-center">Nouvelle quantité</th>
                            <th class="text-end">Prix actuel</th>
                            <th class="text-end">Nouveau prix</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        ventes.forEach(vente => {
            html += `
                <tr>
                    <td class="fw-semibold">${vente.produit_nom}</td>
                    <td class="text-center">
                        <span class="badge bg-info">${vente.stock_actuel || 'N/A'}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary">${vente.quantite}</span>
                    </td>
                    <td class="text-center">
                        <input type="number" 
                               class="form-control form-control-sm" 
                               min="1" 
                               value="${vente.quantite}" 
                               data-vente-id="${vente.id}"
                               onchange="calculateArticleTotal(this)"
                               style="width: 80px;">
                    </td>
                    <td class="text-end">
                        <span class="text-muted">${vente.prix_unitaire.toFixed(2)} $</span>
                    </td>
                    <td class="text-end">
                        <div class="d-flex flex-column align-items-end">
                            <input type="number" 
                                   class="form-control form-control-sm mb-1" 
                                   min="${vente.prix_achat}" 
                                   step="0.01"
                                   value="${vente.prix_unitaire.toFixed(2)}" 
                                   data-vente-id="${vente.id}"
                                   data-prix-achat="${vente.prix_achat}"
                                   onchange="calculateArticleTotal(this)"
                                   style="width: 100px; text-align: right;">
                            <small class="text-muted d-block prix-achat-info">Prix d'achat: ${vente.prix_achat.toFixed(2)} $</small>
                        </div>
                    </td>
                    <td class="text-end fw-bold article-total" 
                        data-quantite="${vente.quantite}"
                        data-prix="${vente.prix_unitaire}">
                        ${vente.montant_total.toFixed(2)} $
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <td colspan="6" class="text-end fw-bold">Nouveau total:</td>
                            <td class="text-end fw-bold" id="new_total_amount">${ventes.reduce((sum, v) => sum + v.montant_total, 0).toFixed(2)} $</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Instructions:</strong>
                <ul class="mb-0 mt-2">
                    <li>Vous pouvez modifier la quantité et/ou le prix unitaire</li>
                    <li>Le prix ne peut pas être inférieur au prix d'achat (${ventes[0]?.prix_achat ? ventes[0].prix_achat.toFixed(2) + ' $' : 'indisponible'})</li>
                    <li>Le total sera recalculé automatiquement</li>
                </ul>
            </div>
        `;
        
        document.getElementById('editArticlesContent').innerHTML = html;
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('editArticlesModal'));
        modal.show();
    }

    // Fonction pour calculer le total d'un article
    function calculateArticleTotal(input) {
        const row = input.closest('tr');
        const quantiteInput = row.querySelector('input[type="number"][min="1"]');
        const prixInput = row.querySelector('input[type="number"][min]');
        
        const quantite = parseInt(quantiteInput.value) || 0;
        const prix = parseFloat(prixInput.value) || 0;
        const prixAchat = parseFloat(prixInput.getAttribute('data-prix-achat')) || 0;
        
        // Validation du prix
        if (prix < prixAchat) {
            alert(`Le prix (${prix.toFixed(2)} $) ne peut pas être inférieur au prix d'achat (${prixAchat.toFixed(2)} $)`);
            prixInput.value = prixAchat.toFixed(2);
            return;
        }
        
        // Validation de la quantité
        if (quantite <= 0) {
            alert('La quantité doit être supérieure à 0');
            quantiteInput.value = 1;
            return;
        }
        
        const total = prix * quantite;
        
        // Mettre à jour les données dans la cellule total
        const totalCell = row.querySelector('.article-total');
        totalCell.setAttribute('data-quantite', quantite);
        totalCell.setAttribute('data-prix', prix);
        totalCell.textContent = total.toFixed(2) + ' $';
        
        calculateNewTotal();
    }

    // Fonction pour calculer le nouveau total
    function calculateNewTotal() {
        let total = 0;
        document.querySelectorAll('.article-total').forEach(cell => {
            total += parseFloat(cell.textContent);
        });
        document.getElementById('new_total_amount').textContent = total.toFixed(2) + ' $';
    }

    // Fonction pour sauvegarder les articles modifiés
    function saveEditedArticles() {
        const factureId = document.getElementById('edit_facture_id').value;
        const ventes = [];
        
        // Créer un Set pour éviter les doublons
        const venteIds = new Set();
        
        // Récupérer les nouvelles quantités et prix
        document.querySelectorAll('input[data-vente-id]').forEach(input => {
            const venteId = parseInt(input.getAttribute('data-vente-id'));
            
            if (!venteIds.has(venteId)) {
                venteIds.add(venteId);
                
                // Trouver la ligne correspondante
                const row = document.querySelector(`tr input[data-vente-id="${venteId}"]`).closest('tr');
                const quantiteInput = row.querySelector('input[type="number"][min="1"]');
                const prixInput = row.querySelector('input[type="number"][min]');
                
                ventes.push({
                    id: venteId,
                    quantite: parseInt(quantiteInput.value) || 0,
                    prix: parseFloat(prixInput.value) || 0
                });
            }
        });
        
        // Validation avant envoi
        for (const vente of ventes) {
            if (vente.quantite <= 0) {
                alert('La quantité doit être supérieure à 0 pour tous les articles');
                return;
            }
            
            // Validation du prix par rapport au prix d'achat
            const prixInput = document.querySelector(`input[data-vente-id="${vente.id}"][min]`);
            const prixAchat = parseFloat(prixInput.getAttribute('data-prix-achat')) || 0;
            
            if (vente.prix < prixAchat) {
                alert(`Le prix (${vente.prix.toFixed(2)} $) ne peut pas être inférieur au prix d'achat (${prixAchat.toFixed(2)} $)`);
                return;
            }
        }
        
        // Envoyer les modifications au serveur
        fetch(`/factures/${factureId}/modifier_articles`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ventes: ventes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editArticlesModal'));
                modal.hide();
                
                // Recharger les données de la facture
                chargerFacturePourEdition(factureId);
                
                // Afficher un message de succès
                let message = 'Articles modifiés avec succès!\n';
                if (data.modifications && data.modifications.length > 0) {
                    message += '\nRésumé des modifications:';
                    data.modifications.forEach(mod => {
                        message += `\n• ${mod.produit}: ${mod.ancienne_quantite} → ${mod.nouvelle_quantite} unités`;
                        if (mod.ancien_prix !== mod.nouveau_prix) {
                            message += `, prix: ${mod.ancien_prix.toFixed(2)} → ${mod.nouveau_prix.toFixed(2)} $`;
                        }
                        message += `, total: ${mod.ancien_montant.toFixed(2)} → ${mod.nouveau_montant.toFixed(2)} $`;
                    });
                }
                message += `\n\nNouveau total de la facture: ${data.nouveau_total.toFixed(2)} $`;
                
                alert(message);
                
                // Recharger la page après un délai pour voir les changements
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la sauvegarde: ' + error.message);
        });
    }

    // Fonction pour imprimer une facture
    function imprimerFacture(factureId) {
        window.open(`/factures/${factureId}/imprimer`, '_blank');
    }

    // Fonction pour réinitialiser la recherche
    function resetSearch() {
        window.location.href = "{{ url_for('routes.factures') }}";
    }
</script>

<!-- Styles supplémentaires -->
<style>
    .card {
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        border-bottom: none;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table td {
        vertical-align: middle;
        padding: 12px 8px;
    }
    
    .facture-row:hover {
        background-color: rgba(0, 0, 0, 0.02);
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }
    
    .btn-group .btn {
        border-radius: 6px;
        margin: 0 2px;
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }

    .modal-xl {
        max-width: 1200px;
    }

    /* Styles pour la modale d'édition */
    #edit_balance_alert {
        font-size: 0.9rem;
    }

    .article-total {
        min-width: 100px;
    }

    .edit-facture-btn:hover {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
    }

    /* Styles pour la modale de modification des articles */
    #editArticlesModal .table input.form-control-sm {
        text-align: center;
    }

    #editArticlesModal .table input.form-control-sm[type="number"][min] {
        text-align: right;
    }

    #editArticlesModal .table td {
        vertical-align: middle;
    }

    #editArticlesModal .badge {
        font-size: 0.7rem;
        padding: 0.25em 0.4em;
    }

    #editArticlesModal .prix-achat-info {
        font-size: 0.75rem;
        color: #666;
    }

    #editArticlesModal .alert ul {
        padding-left: 1.5rem;
    }

    #editArticlesModal .alert li {
        margin-bottom: 0.25rem;
    }

    /* Style pour les prix */
    .prix-cell {
        min-width: 120px;
    }

    @media (max-width: 768px) {
        .container-fluid {
            padding: 10px;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin: 2px 0;
            border-radius: 4px;
        }
        
        .d-flex.justify-content-between.align-items-center.mb-4 {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .d-flex.align-items-center {
            margin-top: 10px;
        }

        .modal-xl {
            max-width: 95%;
            margin: 10px auto;
        }
        
        #editFactureModal .modal-dialog,
        #editArticlesModal .modal-dialog {
            margin: 10px;
        }
        
        #editFactureModal .card,
        #editArticlesModal .card {
            margin-bottom: 10px;
        }
        
        #editArticlesModal .table input.form-control-sm {
            width: 60px !important;
        }
        
        #editArticlesModal .table input.form-control-sm[type="number"][min] {
            width: 80px !important;
        }
    }
</style>
{% endblock %}
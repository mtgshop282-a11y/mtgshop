<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Gestion MKM{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS (local) -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    
    <!-- Font Awesome (local) -->
    <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
    
    <!-- Google Fonts (Roboto) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        /* Votre CSS personnalisé reste inchangé */
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="close-menu" id="close-menu">
            <i class="fas fa-times"></i>
        </div>
        <h2 style="text-align: center;">Menu</h2>

        <!-- Logo -->
        <div class="logo-container" style="text-align: center; margin-top: 20px;">
            <img src="{{ url_for('static', filename='uploads/logo.png') }}" alt="Logo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
        </div>

        <!-- Liens de la barre latérale -->
        <a href="/" class="nav-link {% if request.endpoint == 'routes.index' %}active{% endif %}">
            <i class="fas fa-home"></i> <span>Accueil</span>
        </a>

        <!-- Contenu de la barre latérale -->
        {% if current_user.is_authenticated %}
            <!-- Produits -->
            {% if current_user.has_permission('gestion_produits') or current_user.has_permission('voir_stock_boutique') or current_user.has_permission('voir_stock_globale') %}
                <a href="#produits" class="nav-link dropdown-toggle" id="dropdown-produits">
                    <i class="fas fa-cubes"></i> <span>Produits</span>
                </a>
                <div class="nav-dropdown" id="nav-dropdown-produits">
                    {% if current_user.has_permission('gestion_produits') %}
                        <a href="/gestion_produits" class="nav-link {% if request.endpoint == 'routes.gestion_produits' %}active{% endif %}">
                            <i class="fas fa-edit"></i> <span>Gérer Produits</span>
                        </a>
                        <a href="/produits_en_route" class="nav-link {% if request.endpoint == 'routes.produits_en_route' %}active{% endif %}">
                            <i class="fas fa-truck"></i> <span>Produits en Route</span>
                        </a>
                        <a href="/entrees_sorties" class="nav-link {% if request.endpoint == 'routes.entrees_sorties' %}active{% endif %}">
                            <i class="fas fa-exchange-alt"></i> <span>Entrées et sorties</span>
                        </a>
                    {% endif %}
                    {% if current_user.has_permission('voir_stock_boutique') %}
                        <a href="/stock_boutique" class="nav-link {% if request.endpoint == 'routes.stock_boutique' %}active{% endif %}">
                            <i class="fas fa-store"></i> <span>Stock en Boutique</span>
                        </a>
                    {% endif %}
                    {% if current_user.has_permission('voir_stock_globale') %}
                        <a href="/stock_global" class="nav-link {% if request.endpoint == 'routes.stock_global' %}active{% endif %}">
                            <i class="fas fa-boxes"></i> <span>Stock Global</span>
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Ventes -->
            {% if current_user.has_permission('gestion_ventes') or current_user.has_permission('voir_historique_vente') or current_user.has_permission('gestion_benefices') %}
                <a href="#ventes" class="nav-link dropdown-toggle" id="dropdown-ventes">
                    <i class="fas fa-shopping-cart"></i> <span>Ventes</span>
                </a>
                <div class="nav-dropdown" id="nav-dropdown-ventes">
                    {% if current_user.has_permission('gestion_ventes') %}
                        <a href="/ventes" class="nav-link {% if request.endpoint == 'routes.ventes' %}active{% endif %}">
                            <i class="fas fa-cart-plus"></i> <span>Gérer Ventes</span>
                        </a>
                    {% endif %}
                    {% if current_user.has_permission('voir_historique_vente') %}
                        <a href="/historique_ventes" class="nav-link {% if request.endpoint == 'routes.historique_ventes' %}active{% endif %}">
                            <i class="fas fa-history"></i> <span>Historique des Ventes</span>
                        </a>
                        <a href="/factures" class="nav-link {% if request.endpoint == 'routes.factures' %}active{% endif %}">
                            <i class="fas fa-file-invoice"></i> <span>Factures</span>
                        </a>
                        <!-- NOUVEAU : Lien vers les factures en crédit -->
                        <a href="/factures_credit" class="nav-link {% if request.endpoint == 'routes.factures_credit' %}active{% endif %}">
                            <i class="fas fa-credit-card"></i> <span>Factures Crédit</span>
                            {% if factures_credit_count > 0 %}
                                <span class="badge bg-danger ms-1">{{ factures_credit_count }}</span>
                            {% endif %}
                        </a>
                    {% endif %}
                    {% if current_user.has_permission('gestion_benefices') %}
                        <a href="/benefices" class="nav-link {% if request.endpoint == 'routes.gestion_benefices' %}active{% endif %}">
                            <i class="fas fa-chart-line"></i> <span>Gestion des Bénéfices</span>
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Dépenses -->
            {% if current_user.has_permission('gestion_depenses_ordinaires') or current_user.has_permission('gestion_depenses_recurrentes') %}
                <a href="#depenses" class="nav-link dropdown-toggle" id="dropdown-depenses">
                    <i class="fas fa-money-bill-wave"></i> <span>Dépenses</span>
                </a>
                <div class="nav-dropdown" id="nav-dropdown-depenses">
                    {% if current_user.has_permission('gestion_depenses_ordinaires') %}
                        <a href="/depenses_ordinaires" class="nav-link {% if request.endpoint == 'routes.depenses_ordinaires' %}active{% endif %}">
                            <i class="fas fa-list"></i> <span>Gérer Dépenses Ordinaires</span>
                        </a>
                    {% endif %}
                    {% if current_user.has_permission('gestion_depenses_recurrentes') %}
                        <a href="/depenses_recurrentes" class="nav-link {% if request.endpoint == 'routes.depenses_recurrentes' %}active{% endif %}">
                            <i class="fas fa-list"></i> <span>Gérer Dépenses Récurrentes</span>
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Dépôt -->
            {% if current_user.has_permission('gestion_depot') or current_user.has_permission('voir_stock_depot') %}
                <a href="#depot" class="nav-link dropdown-toggle" id="dropdown-depot">
                    <i class="fas fa-warehouse"></i> <span>Dépôt</span>
                </a>
                <div class="nav-dropdown" id="nav-dropdown-depot">
                    {% if current_user.has_permission('gestion_depot') %}
                        <a href="/gestion_transactions_depot" class="nav-link {% if request.endpoint == 'routes.gestion_transactions_depot' %}active{% endif %}">
                            <i class="fas fa-exchange-alt"></i> <span>Gérer Transactions Dépôt</span>
                        </a>
                    {% endif %}
                    {% if current_user.has_permission('voir_stock_depot') %}
                        <a href="/stock_depot" class="nav-link {% if request.endpoint == 'routes.stock_depot' %}active{% endif %}">
                            <i class="fas fa-boxes"></i> <span>Voir le Stock au Dépôt</span>
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Caisse -->
            {% if current_user.has_permission('gestion_caise') %}
                <a href="/gestion_caisse" class="nav-link {% if request.endpoint == 'routes.gestion_caisse' %}active{% endif %}">
                    <i class="fas fa-cash-register"></i> <span>Gestion de la Caisse</span>
                </a>
            {% endif %}

            <!-- Compte Bancaire -->
            {% if current_user.has_permission('gestion_banque') %}
                <a href="/gestion_compte_bancaire" class="nav-link {% if request.endpoint == 'routes.gestion_compte_bancaire' %}active{% endif %}">
                    <i class="fas fa-piggy-bank"></i> <span>Gestion du Compte Bancaire</span>
                </a>
            {% endif %}

            <!-- Utilisateurs -->
            {% if current_user.has_permission('gestion_utilisateurs') %}
                <a href="/gestion_utilisateurs" class="nav-link {% if request.endpoint == 'routes.gestion_utilisateurs' %}active{% endif %}">
                    <i class="fas fa-users-cog"></i> <span>Gestion des Utilisateurs</span>
                </a>
            {% endif %}

            <!-- Télécharger la Base de Données -->
            {% if current_user.has_permission('gestion_utilisateurs') %}
                <a href="{{ url_for('routes.telecharger_base_donnees') }}" class="nav-link">
                    <i class="fas fa-database"></i> <span>Télécharger Base de Données</span>
                </a>
            {% endif %}

            <!-- Paramètres -->
            <a href="/parametres" class="nav-link {% if request.endpoint == 'routes.parametres' %}active{% endif %}">
                <i class="fas fa-cog"></i> <span>Paramètres</span>
            </a>
        {% endif %}
    </div>

    <!-- Overlay pour le menu mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Content -->
    <div class="content">
        <!-- Header -->
        <div class="header">
            <!-- Bouton pour ouvrir/fermer le menu sur mobile -->
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>

            <!-- Notifications -->
            <div class="dropdown">
                <!-- Contenu des notifications -->
            </div>
            
            <!-- Profile -->
            <div class="dropdown">
                {% if current_user.is_authenticated %}
                    <button class="btn btn-light dropdown-toggle" id="profileDropdown" data-bs-toggle="dropdown">
                        <img src="{{ url_for('static', filename=current_user.photo if current_user.photo else 'images/default.png') }}" 
                             alt="Profile Picture" width="40" height="40" class="rounded-circle">
                        {{ current_user.firstname }} {{ current_user.lastname }}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="profileDropdown">
                        <!-- Logo de l'application dans un cercle -->
                        <li class="logo-container">
                            <img src="{{ url_for('static', filename=current_user.photo if current_user.photo else 'images/default.png') }}" 
                                 alt="Profile Picture" class="rounded-circle">
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/profile"><i class="fas fa-user"></i> Votre Profil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
                    </ul>
                {% else %}
                    <a href="/login" class="btn btn-light">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mt-5">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Bootstrap 5 JS and dependencies (local) -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    
    <!-- Custom JS -->
    <script>
        // Gestion du menu mobile
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuToggle = document.getElementById('menu-toggle');
        const closeMenu = document.getElementById('close-menu');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        });

        closeMenu.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        });

        // Gestion des dropdowns au clic
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownId = toggle.getAttribute('id').replace('dropdown-', 'nav-dropdown-');
                const dropdown = document.getElementById(dropdownId);
                dropdown.classList.toggle('open');
                toggle.classList.toggle('active');
            });
        });

        // Fermer les dropdowns en cliquant à l'extérieur
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-toggle') && !e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
                    toggle.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>
{% extends "layout.html" %}

{% block title %}Historique des Ventes{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-5 text-center"><i class="fas fa-history me-2"></i> Historique des Ventes</h1>

    <!-- Formulaire de filtrage -->
    <div class="card mt-4 shadow-sm border-0">
        <div class="card-header text-white" style="background-color: #2C3E50;">
            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i> Filtrer les Ventes</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Filtre par date de début -->
                <div class="col-md-3">
                    <label for="filterDateStart" class="form-label">Date de début</label>
                    <input type="date" class="form-control" id="filterDateStart">
                </div>

                <!-- Filtre par date de fin -->
                <div class="col-md-3">
                    <label for="filterDateEnd" class="form-label">Date de fin</label>
                    <input type="date" class="form-control" id="filterDateEnd">
                </div>

                <!-- Filtre par nom de produit -->
                <div class="col-md-3">
                    <label for="filterProduct" class="form-label">Nom du produit</label>
                    <input type="text" class="form-control" id="filterProduct" placeholder="Rechercher par produit...">
                </div>

                <!-- Filtre par numéro de facture -->
                <div class="col-md-3">
                    <label for="filterFacture" class="form-label">Facture</label>
                    <input type="text" class="form-control" id="filterFacture" placeholder="Rechercher par facture...">
                </div>
            </div>

            <!-- Boutons pour réinitialiser les filtres, exporter en CSV et imprimer -->
            <div class="mt-3 d-flex justify-content-between">
                <button type="button" id="resetFilters" class="btn btn-secondary">
                    <i class="fas fa-sync-alt me-2"></i> Réinitialiser les filtres
                </button>
                <div>
                    <button type="button" id="exportCSV" class="btn btn-success me-2">
                        <i class="fas fa-file-csv me-2"></i> Exporter en CSV
                    </button>
                    <button type="button" id="printButton" class="btn btn-primary">
                        <i class="fas fa-print me-2"></i> Imprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des ventes -->
    <div class="card mt-4 shadow-sm border-0">
        <div class="card-header text-white" style="background-color: #27AE60;">
            <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i> Liste des Ventes</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead style="background-color: #2c3e50; color: white;">
                    <tr>
                        <th class="text-center">Date</th>
                        <th class="text-center">Facture</th>
                        <th class="text-center">Produit</th>
                        <th class="text-center">Quantité</th>
                        <th class="text-center">Montant Total</th>
                    </tr>
                </thead>
                <tbody id="ventesTableBody">
                    {% for vente in ventes %}
                    <tr data-date="{{ vente.facture.date_facture.strftime('%Y-%m-%d') }}" data-facture="{{ vente.facture.id }}" data-produit="{{ vente.produit.nom }}">
                        <td class="text-center">{{ vente.facture.date_facture.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td class="text-center">{{ vente.facture.id }}</td>
                        <td class="text-center">{{ vente.produit.nom }}</td>
                        <td class="text-center">{{ vente.quantite }}</td>
                        <td class="text-center">{{ vente.montant_total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Total des ventes -->
            <div class="text-center mt-4 p-3 bg-light rounded shadow-sm">
                <h3 class="text-success mb-0">
                    <i class="fas fa-coins me-2"></i>
                    <strong>Total des ventes : <span id="totalVentes">0.00</span></strong>
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Script pour le filtrage, le total des ventes, l'export en CSV et l'impression -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterDateStart = document.getElementById('filterDateStart');
        const filterDateEnd = document.getElementById('filterDateEnd');
        const filterProduct = document.getElementById('filterProduct');
        const filterFacture = document.getElementById('filterFacture');
        const ventesTableBody = document.getElementById('ventesTableBody');
        const rows = Array.from(ventesTableBody.getElementsByTagName('tr'));
        const totalVentes = document.getElementById('totalVentes');
        const exportCSVButton = document.getElementById('exportCSV');
        const printButton = document.getElementById('printButton');

        // Fonction pour obtenir la date du jour au format YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Fonction pour filtrer les ventes
        function filterVentes() {
            const startDate = filterDateStart.value || getTodayDate(); // Par défaut, la date du jour
            const endDate = filterDateEnd.value || getTodayDate(); // Par défaut, la date du jour
            const product = filterProduct.value.toLowerCase();
            const facture = filterFacture.value.toLowerCase();

            let total = 0;

            rows.forEach(row => {
                const date = row.getAttribute('data-date');
                const rowFacture = row.getAttribute('data-facture').toLowerCase();
                const rowProduct = row.getAttribute('data-produit').toLowerCase();

                const matchesDate = date >= startDate && date <= endDate;
                const matchesProduct = !product || rowProduct.includes(product);
                const matchesFacture = !facture || rowFacture.includes(facture);

                if (matchesDate && matchesProduct && matchesFacture) {
                    row.style.display = '';
                    total += parseFloat(row.cells[4].textContent); // Ajouter au total
                } else {
                    row.style.display = 'none';
                }
            });

            totalVentes.textContent = total.toFixed(2); // Afficher le total
        }

        // Fonction pour exporter les données en CSV
        function exportToCSV() {
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            const headers = ["Date", "Facture", "Produit", "Quantité", "Montant Total"];
            const csvContent = [
                headers.join(","), // En-têtes
                ...visibleRows.map(row => {
                    const cells = Array.from(row.cells);
                    return cells.map(cell => cell.textContent).join(",");
                })
            ].join("\n");

            // Créer un fichier CSV et le télécharger
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "historique_ventes.csv";
            link.click();
        }

        // Fonction pour imprimer le tableau
        function printTable() {
            const printContents = `
                <style>
                    body { font-family: Arial, sans-serif; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    th { background-color: #2c3e50; color: white; }
                    .total { font-size: 1.2rem; font-weight: bold; text-align: center; margin-top: 20px; }
                </style>
                <h2 style="text-align: center;">Historique des Ventes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Facture</th>
                            <th>Produit</th>
                            <th>Quantité</th>
                            <th>Montant Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Array.from(rows)
                            .filter(row => row.style.display !== 'none')
                            .map(row => `
                                <tr>
                                    <td>${row.cells[0].textContent}</td>
                                    <td>${row.cells[1].textContent}</td>
                                    <td>${row.cells[2].textContent}</td>
                                    <td>${row.cells[3].textContent}</td>
                                    <td>${row.cells[4].textContent}</td>
                                </tr>
                            `).join('')}
                    </tbody>
                </table>
                <div class="total">
                    <strong>Total des ventes : ${totalVentes.textContent}</strong>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(printContents);
            printWindow.document.close();
            printWindow.print();
        }

        // Appliquer les filtres lors de la modification des champs
        filterDateStart.addEventListener('change', filterVentes);
        filterDateEnd.addEventListener('change', filterVentes);
        filterProduct.addEventListener('input', filterVentes);
        filterFacture.addEventListener('input', filterVentes);

        // Réinitialiser les filtres
        document.getElementById('resetFilters').addEventListener('click', function() {
            filterDateStart.value = '';
            filterDateEnd.value = '';
            filterProduct.value = '';
            filterFacture.value = '';
            filterVentes();
        });

        // Exporter en CSV
        exportCSVButton.addEventListener('click', exportToCSV);

        // Imprimer le tableau
        printButton.addEventListener('click', printTable);

        // Appliquer le filtre par défaut (ventes du jour) au chargement de la page
        filterVentes();
    });
</script>

<!-- Styles supplémentaires -->
<style>
    /* Style du tableau */
    .table {
        border-collapse: collapse;
        width: 100%;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .table th, .table td {
        padding: 12px;
        text-align: center; /* Centrer le texte dans les cellules */
        border-bottom: 2px solid #ddd;
    }

    .table th {
        background-color: #2c3e50;
        color: white;
        font-weight: bold;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
    }

    /* Style du total des ventes */
    .bg-light {
        background-color: #f8f9fa !important;
    }

    .text-success {
        font-size: 1.5rem;
        font-weight: bold;
    }

    /* Style des boutons */
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }

    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
</style>
{% endblock %}
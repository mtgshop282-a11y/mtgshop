{% extends "layout.html" %}

{% block title %}Gestion des Dépenses Ordinaires{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-5 text-center"><i class="fas fa-money-bill-wave"></i> Gestion des Dépenses Ordinaires</h1>

    <!-- Afficher les messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Formulaire pour ajouter une dépense ordinaire -->
    <div class="card mt-4 shadow-sm border-0">
        <div class="card-header text-white" style="background-color: #2C3E50;">
            <h5 class="card-title mb-0"><i class="fas fa-plus-circle me-2"></i> Ajouter une dépense ordinaire</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('routes.ajouter_depense') }}" method="POST">
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <input type="text" class="form-control" id="description" name="description" required>
                </div>
                <div class="mb-3">
                    <label for="montant" class="form-label">Montant</label>
                    <input type="number" step="0.01" class="form-control" id="montant" name="montant" required>
                </div>
                <div class="mb-3">
                    <label for="categorie" class="form-label">Catégorie (optionnel)</label>
                    <input type="text" class="form-control" id="categorie" name="categorie">
                </div>
                <button type="submit" class="btn text-white w-100" style="background-color: #2980B9;">
                    <i class="fas fa-save me-2"></i> Ajouter
                </button>
            </form>
        </div>
    </div>

    <!-- Formulaire de filtrage -->
    <div class="card mt-4 shadow-sm border-0">
        <div class="card-header text-white" style="background-color: #2C3E50;">
            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i> Filtrer les Dépenses</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Filtre par date de début -->
                <div class="col-md-3">
                    <label for="filterDateStart" class="form-label">Date de début</label>
                    <input type="date" class="form-control" id="filterDateStart">
                </div>

                <!-- Filtre par date de fin -->
                <div class="col-md-3">
                    <label for="filterDateEnd" class="form-label">Date de fin</label>
                    <input type="date" class="form-control" id="filterDateEnd">
                </div>

                <!-- Filtre par catégorie -->
                <div class="col-md-3">
                    <label for="filterCategorie" class="form-label">Catégorie</label>
                    <input type="text" class="form-control" id="filterCategorie" placeholder="Rechercher par catégorie...">
                </div>

                <!-- Filtre par description -->
                <div class="col-md-3">
                    <label for="filterDescription" class="form-label">Description</label>
                    <input type="text" class="form-control" id="filterDescription" placeholder="Rechercher par description...">
                </div>
            </div>

            <!-- Boutons pour réinitialiser les filtres, exporter en CSV et imprimer -->
            <div class="mt-3 d-flex justify-content-between">
                <button type="button" id="resetFilters" class="btn btn-secondary">
                    <i class="fas fa-sync-alt me-2"></i> Réinitialiser les filtres
                </button>
                <div>
                    <button type="button" id="exportCSV" class="btn btn-success me-2">
                        <i class="fas fa-file-csv me-2"></i> Exporter en CSV
                    </button>
                    <button type="button" id="printButton" class="btn btn-primary">
                        <i class="fas fa-print me-2"></i> Imprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des dépenses ordinaires -->
    <div class="card mt-4 shadow-sm border-0">
        <div class="card-header text-white" style="background-color: #27AE60;">
            <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i> Liste des Dépenses Ordinaires</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead style="background-color: #2c3e50; color: white;">
                    <tr>
                        <th class="text-center">Description</th>
                        <th class="text-center">Montant</th>
                        <th class="text-center">Catégorie</th>
                        <th class="text-center">Date</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="depensesTableBody">
                    {% for depense in depenses %}
                    <tr data-date="{{ depense.date_depense.strftime('%Y-%m-%d') }}" data-categorie="{{ depense.categorie }}" data-description="{{ depense.description }}">
                        <td class="text-center">{{ depense.description }}</td>
                        <td class="text-center">{{ depense.montant }}</td>
                        <td class="text-center">{{ depense.categorie }}</td>
                        <td class="text-center">{{ depense.date_depense.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td class="text-center">
                            <!-- Bouton pour modifier une dépense -->
                            <button type="button" class="btn btn-sm text-white" style="background-color: #f39c12;" data-bs-toggle="modal" data-bs-target="#modalModifier{{ depense.id }}">
                                <i class="fas fa-edit me-2"></i> Modifier
                            </button>
                            <!-- Bouton pour supprimer une dépense -->
                            <button type="button" class="btn btn-sm btn-danger btn-supprimer" data-id="{{ depense.id }}" data-description="{{ depense.description }}">
                                <i class="fas fa-trash me-2"></i> Supprimer
                            </button>
                        </td>
                    </tr>

                    <!-- Modal pour modifier une dépense -->
                    <div class="modal fade" id="modalModifier{{ depense.id }}" tabindex="-1" aria-labelledby="modalModifierLabel{{ depense.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #f39c12; color: white;">
                                    <h5 class="modal-title" id="modalModifierLabel{{ depense.id }}">Modifier la dépense</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="{{ url_for('routes.modifier_depense', id=depense.id) }}" method="POST">
                                        <div class="mb-3">
                                            <label for="description{{ depense.id }}" class="form-label">Description</label>
                                            <input type="text" class="form-control" id="description{{ depense.id }}" name="description" value="{{ depense.description }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="montant{{ depense.id }}" class="form-label">Montant</label>
                                            <input type="number" step="0.01" class="form-control" id="montant{{ depense.id }}" name="montant" value="{{ depense.montant }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="categorie{{ depense.id }}" class="form-label">Catégorie (optionnel)</label>
                                            <input type="text" class="form-control" id="categorie{{ depense.id }}" name="categorie" value="{{ depense.categorie }}">
                                        </div>
                                        <button type="submit" class="btn text-white w-100" style="background-color: #f39c12;">
                                            <i class="fas fa-save me-2"></i> Enregistrer
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Total des dépenses -->
            <div class="text-center mt-4 p-3 bg-light rounded shadow-sm">
                <h3 class="text-success mb-0">
                    <i class="fas fa-coins me-2"></i>
                    <strong>Total des dépenses : <span id="totalDepenses">0.00</span></strong>
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Script pour le filtrage, le total des dépenses, l'export en CSV et l'impression -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterDateStart = document.getElementById('filterDateStart');
        const filterDateEnd = document.getElementById('filterDateEnd');
        const filterCategorie = document.getElementById('filterCategorie');
        const filterDescription = document.getElementById('filterDescription');
        const depensesTableBody = document.getElementById('depensesTableBody');
        const rows = Array.from(depensesTableBody.getElementsByTagName('tr'));
        const totalDepenses = document.getElementById('totalDepenses');
        const exportCSVButton = document.getElementById('exportCSV');
        const printButton = document.getElementById('printButton');

        // Fonction pour obtenir la date du jour au format YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Fonction pour filtrer les dépenses
        function filterDepenses() {
            const startDate = filterDateStart.value || getTodayDate(); // Par défaut, la date du jour
            const endDate = filterDateEnd.value || getTodayDate(); // Par défaut, la date du jour
            const categorie = filterCategorie.value.toLowerCase();
            const description = filterDescription.value.toLowerCase();

            let total = 0;

            rows.forEach(row => {
                const date = row.getAttribute('data-date');
                const rowCategorie = row.getAttribute('data-categorie').toLowerCase();
                const rowDescription = row.getAttribute('data-description').toLowerCase();

                const matchesDate = date >= startDate && date <= endDate;
                const matchesCategorie = !categorie || rowCategorie.includes(categorie);
                const matchesDescription = !description || rowDescription.includes(description);

                if (matchesDate && matchesCategorie && matchesDescription) {
                    row.style.display = '';
                    total += parseFloat(row.cells[1].textContent); // Ajouter au total
                } else {
                    row.style.display = 'none';
                }
            });

            totalDepenses.textContent = total.toFixed(2); // Afficher le total
        }

        // Fonction pour exporter les données en CSV
        function exportToCSV() {
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            const headers = ["Description", "Montant", "Catégorie", "Date"];
            const csvContent = [
                headers.join(","), // En-têtes
                ...visibleRows.map(row => {
                    const cells = Array.from(row.cells).slice(0, 4); // Exclure la colonne Actions
                    return cells.map(cell => cell.textContent).join(",");
                })
            ].join("\n");

            // Créer un fichier CSV et le télécharger
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "depenses_ordinaires.csv";
            link.click();
        }

        // Fonction pour imprimer le tableau
        function printTable() {
            const printContents = `
                <style>
                    body { font-family: Arial, sans-serif; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    th { background-color: #2c3e50; color: white; }
                    .total { font-size: 1.2rem; font-weight: bold; text-align: center; margin-top: 20px; }
                </style>
                <h2 style="text-align: center;">Historique des Dépenses Ordinaires</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Montant</th>
                            <th>Catégorie</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Array.from(rows)
                            .filter(row => row.style.display !== 'none')
                            .map(row => `
                                <tr>
                                    <td>${row.cells[0].textContent}</td>
                                    <td>${row.cells[1].textContent}</td>
                                    <td>${row.cells[2].textContent}</td>
                                    <td>${row.cells[3].textContent}</td>
                                </tr>
                            `).join('')}
                    </tbody>
                </table>
                <div class="total">
                    <strong>Total des dépenses : ${totalDepenses.textContent}</strong>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(printContents);
            printWindow.document.close();
            printWindow.print();
        }

        // Appliquer les filtres lors de la modification des champs
        filterDateStart.addEventListener('change', filterDepenses);
        filterDateEnd.addEventListener('change', filterDepenses);
        filterCategorie.addEventListener('input', filterDepenses);
        filterDescription.addEventListener('input', filterDepenses);

        // Réinitialiser les filtres
        document.getElementById('resetFilters').addEventListener('click', function() {
            filterDateStart.value = '';
            filterDateEnd.value = '';
            filterCategorie.value = '';
            filterDescription.value = '';
            filterDepenses();
        });

        // Exporter en CSV
        exportCSVButton.addEventListener('click', exportToCSV);

        // Imprimer le tableau
        printButton.addEventListener('click', printTable);

        // Appliquer le filtre par défaut (dépenses du jour) au chargement de la page
        filterDepenses();
    });
</script>

<!-- Styles supplémentaires -->
<style>
    /* Style du tableau */
    .table {
        border-collapse: collapse;
        width: 100%;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .table th, .table td {
        padding: 12px;
        text-align: center; /* Centrer le texte dans les cellules */
        border-bottom: 2px solid #ddd;
    }

    .table th {
        background-color: #2c3e50;
        color: white;
        font-weight: bold;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
    }

    /* Style du total des dépenses */
    .bg-light {
        background-color: #f8f9fa !important;
    }

    .text-success {
        font-size: 1.5rem;
        font-weight: bold;
    }

    /* Style des boutons */
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }

    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
</style>
{% endblock %}